---
title: 'VueæŒ‡ä»¤ å®ç°ç¦æ­¢æ–‡ä»¶é‡å¤ä¸‹è½½'
date: '2023-04-25'
url: 'vue-directive-prevent-duplicate-file-downloads'
summary: åœ¨æ—¥å¸¸çš„å¼€å‘å·¥ä½œä¸­ï¼Œç»å¸¸éœ€è¦å¤„ç†æ–‡ä»¶ä¸‹è½½åœºæ™¯ã€‚ä¸ºäº†é¿å…ç”¨æˆ·é‡å¤ç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œäº§ç”Ÿå¤§é‡è¯·æ±‚ï¼Œæœ¬æ–‡ä½¿ç”¨äº†VueæŒ‡ä»¤ç”Ÿæˆä¸€ä¸ªé€šç”¨æ–¹æ¡ˆå¤„ç†è¯¥åœºæ™¯
tags:
  - Vue
  - Axios
---

# å‰è¨€

æ—¥å¸¸è¿›è¡Œå¼€å‘å·¥ä½œæ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°ä¸‹è½½æ–‡ä»¶çš„åœºæ™¯ï¼Œé€šå¸¸ç”¨æˆ·ç‚¹å‡»ä¸‹è½½åéœ€è¦ç¦æ­¢é‡å¤ç‚¹å‡»ä¸‹è½½ä»¥ä¿è¯ä¸ä¼šå‘é€å¤§é‡è¯·æ±‚ï¼ŒæŒ‰é’®ç¦ç”¨æ—¶å†æ·»åŠ ä¸€ä¸ªloadingçŠ¶æ€æä¾›æ›´å¥½çš„è§†è§‰ä½“éªŒã€‚
å•ä¸ªé¡µé¢å†…å®ç°éå¸¸ç®€å•ï¼šè®¾ç½®ä¸€ä¸ªloadingå˜é‡ï¼Œåœ¨ç”¨æˆ·è¿›è¡Œæ“ä½œå‰ååˆ†åˆ«è®¾ç½®æŒ‰é’®çš„loadingçŠ¶æ€å’ŒdisabledçŠ¶æ€å³å¯ã€‚ä½†æ˜¯1ä¸ªé¡µé¢å†™ä¸€æ¬¡ï¼Œ10ä¸ªé¡µé¢ã€100ä¸ªé¡µé¢å‘¢ï¼Ÿå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ç§é€šç”¨çš„æ–¹æ³•å»è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè‡ªç„¶è€Œç„¶ä¹Ÿå°±æƒ³åˆ°äº†VueæŒ‡ä»¤ã€‚

# å®ç°æ€è·¯

> é™¤äº†æ ¸å¿ƒåŠŸèƒ½é»˜è®¤å†…ç½®çš„æŒ‡ä»¤ (v-model å’Œ v-show)ï¼ŒVue ä¹Ÿå…è®¸æ³¨å†Œè‡ªå®šä¹‰æŒ‡ä»¤ã€‚æ³¨æ„ï¼Œåœ¨ Vue2.0 ä¸­ï¼Œä»£ç å¤ç”¨å’ŒæŠ½è±¡çš„ä¸»è¦å½¢å¼æ˜¯ç»„ä»¶ã€‚ç„¶è€Œï¼Œæœ‰çš„æƒ…å†µä¸‹ï¼Œä½ ä»ç„¶éœ€è¦å¯¹æ™®é€š DOM å…ƒç´ è¿›è¡Œåº•å±‚æ“ä½œï¼Œè¿™æ—¶å€™å°±ä¼šç”¨åˆ°è‡ªå®šä¹‰æŒ‡ä»¤

æ•´ä½“å®ç°åˆ†ä¸ºä¸¤éƒ¨åˆ†(Vue + Element + Axiosä¸ºä¾‹)ï¼š
1. axiosä¸­ï¼Œæ–‡ä»¶ä¸‹è½½æ—¶å‘å…¨å±€æ·»åŠ flagå˜é‡ä»£è¡¨ä¸‹è½½çŠ¶æ€
2. æŒ‡ä»¤ä¸­ï¼Œå½“æ£€æµ‹åˆ°æ–‡ä»¶ä¸‹è½½æ—¶ç¦ç”¨æŒ‰é’®å¹¶æ·»åŠ loadingçŠ¶æ€ï¼Œä¸‹è½½å®Œæ¯•æ—¶æ¢å¤åŸçŠ¶

# å®ç°è¿‡ç¨‹

## ä¸€ã€å…¨å±€ä¸ŠæŠ¥ä¸‹è½½è¿›åº¦

å®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨æ¥å‘å…¨å±€ä¸ŠæŠ¥ä¸‹è½½è¿›åº¦ï¼Œå½“æ–‡ä»¶é•¿åº¦å¯è®¡ç®—æ—¶ï¼Œå®šä¹‰ä¸€ä¸ªåä¸º`isFileDownloading`çš„flagï¼Œç”¨äºåˆ¤æ–­å½“å‰æ–‡ä»¶æ˜¯å¦ä¸‹è½½å®Œæ¯•ï¼š
```javascript
// axios.js

// å‘å…¨å±€æ·»åŠ ä¸‹è½½è¿›åº¦
const addDownloadProgress = (progressEvent) => {
  // ä»…é’ˆå¯¹æ–‡ä»¶é•¿åº¦å¯è®¡ç®—çš„æƒ…å†µ
  if (progressEvent.lengthComputable) {
    window.isFileDownloading = progressEvent.loaded !== progressEvent.total;
  } else {
    window.isFileDownloading = false;
  }
};
```

Axioså®˜ç½‘çš„è¯·æ±‚é…ç½®æœ‰ä¸€é¡¹`onDownloadingProgress`å±æ€§ç”¨äºå¤„ç†ä¸‹è½½äº‹ä»¶
```javascript
// `onDownloadProgress` allows handling of progress events for downloads
// browser only
onDownloadProgress: function (progressEvent) {
  // Do whatever you want with the native progress event
}
```
å½“æ¥å£æ˜¯ç”¨äºä¸‹è½½æ–‡ä»¶æ—¶æ‰æ±‡æŠ¥è¿›åº¦ï¼š
```javascript
// axios.js

// ä¸‹è½½æ–‡ä»¶æ—¶å‘å…¨å±€æ±‡æŠ¥è¿›åº¦ï¼Œç”¨äºç¦æ­¢é‡å¤ä¸‹è½½æŒ‡ä»¤
if (conf.responseType === 'blob') {
  if (!conf['onDownloadProgress']) {
    conf['onDownloadProgress'] = addDownloadProgress;
  }
}
```

## äºŒã€ç›‘å¬å…¨å±€å˜é‡å¹¶æ›´æ–°çŠ¶æ€

ä½¿ç”¨VueæŒ‡ä»¤ï¼Œä½¿ç”¨å®šæ—¶å™¨è½®è¯¢ä¸Šè¿°æ­¥éª¤åˆ›å»ºçš„flagï¼Œæ ¹æ®flagä¿®æ”¹æŒ‰é’®çŠ¶æ€ï¼Œä¸»è¦ä»£ç ï¼š
```javascript
// preventReDownload.js

let changeToDownloading = null;

export default {
  install(Vue) {
    Vue.directive('preventReDownload', {
      bind(el) {
        let timer = null;
        changeToDownloading = () => {
          el.disabled = true;
          el.classList.add('is-disabled', 'is-loading');
          // è½®è¯¢axioså‘å…¨å±€å˜é‡ä¸­æ·»åŠ çš„æ–‡ä»¶ä¸‹è½½çŠ¶æ€flag
          timer = setInterval(() => {
            if (!window.isFileDownloading) {
              console.log('done!');
              clearInterval(timer);
              el.disabled = false;
              el.classList.remove('is-disabled', 'is-loading');
              el.removeChild(el.firstChild);
            }
          }, 500);
        };
        el.addEventListener('click', changeToDownloading);
      },
      unbind() {
        document.removeEventListener('click', changeToDownloading);
      }
    });
  }
};
```

åŠ ä¸Šåœ†åœˆåŠ¨æ•ˆçš„å®Œæ•´ä»£ç ï¼š
```javascript
// preventReDownload.js

// function å°†æŒ‰é’®æ”¹å˜ä¸ºä¸‹è½½ä¸­çŠ¶æ€
let changeToDownloading = null;
// loading åŠ¨æ•ˆåœ†åœˆ
const loadingEle = document.createElement('div');
loadingEle.setAttribute('class', 'el-loading-spinner');
loadingEle.innerHTML = `
  <svg class="circular" viewBox="0 0 16 16">
    <circle class="path" cx="8" cy="8" r="7" fill="none"/>
  </svg>
`;

export default {
  install(Vue) {
    Vue.directive('preventReDownload', {
      bind(el) {
        let timer = null;
        changeToDownloading = () => {
          el.disabled = true;
          el.classList.add('is-disabled', 'is-loading');
          el.prepend(loadingEle);
          // è½®è¯¢axioså‘å…¨å±€å˜é‡ä¸­æ·»åŠ çš„æ–‡ä»¶ä¸‹è½½çŠ¶æ€flag
          timer = setInterval(() => {
            if (!window.isFileDownloading) {
              console.log('done!');
              clearInterval(timer);
              el.disabled = false;
              el.classList.remove('is-disabled', 'is-loading');
              el.removeChild(el.firstChild);
            }
          }, 500);
        };
        el.addEventListener('click', changeToDownloading);
      },
      unbind() {
        document.removeEventListener('click', changeToDownloading);
      }
    });
  }
};
```

# ä½¿ç”¨æ–¹æ³•
åœ¨æŒ‰é’®ä¸­ä½¿ç”¨æŒ‡ä»¤`v-prevent-re-download`ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘ä¸‹è½½æ¥å£ï¼š
```
<el-button v-prevent-re-download type="primary" @click="onDownload">ä¸‹è½½</el-button>
```

å¯ä»¥çœ‹åˆ°æŒ‰é’®å˜æˆloadingä¸disabledçŠ¶æ€ï¼Œæ§åˆ¶å°æ‰“å°äº†ä¸‹è½½è¿‡ç¨‹ä»¥åŠä¸‹è½½å®Œæˆçš„ä¿¡æ¯ï¼š
<Image src="https://chev.contrails.space:12650/images/2024/06/10/68f1ea5386b0ed83fadfe8e0befa2ea2.png" alt="æŒ‰é’®çŠ¶æ€" />
<Image src="https://chev.contrails.space:12650/images/2024/06/10/c3dd861dfd4f74740a4f6fd94d0c9767.png" alt="æ§åˆ¶å°ä¿¡æ¯" />

# ç¼ºé™·
è¿™ä¸ªæ–¹æ³•æœ‰ä¸€äº›ç‘•ç–µï¼š
1. ä»£ç æœ‰ä¸€å®šå…¥ä¾µæ€§ï¼Œå¯¹è¯·æ±‚å°è£…åšäº†ä¸€å®šçš„ä¿®æ”¹ï¼Œè€Œä¸”å½“è¯¥è¯·æ±‚æœ¬èº«å·²ç»è®¾ç½®äº†`isFileDownloading`æ—¶å°±ä¼šå‡ºé—®é¢˜ï¼Œå› æ­¤æˆ‘è·³è¿‡äº†æœ¬èº«å·²è®¾ç½®è¯¥å±æ€§çš„æ¥å£
2. LoadingçŠ¶æ€çš„æ ·å¼è¿˜æœ‰äº›é—®é¢˜ï¼Œplainå±æ€§çš„æŒ‰é’®å’Œè¡¨æ ¼æ“ä½œåˆ—æŒ‰é’®éƒ½æ— æ³•æ˜¾ç¤ºï¼Œå› ä¸ºè¿™ä¸ªåœˆæ˜¯ç™½è‰²çš„ï¼Œè¿™ä¸ªæ ¹æ®éœ€è¦è‡ªè¡Œä¿®æ”¹å§ğŸ˜‚

---
### å‚è€ƒèµ„æ–™

[Vue åˆ©ç”¨æŒ‡ä»¤å®ç°ç¦æ­¢åå¤å‘é€è¯·æ±‚çš„ä¸¤ç§æ–¹æ³•](https://www.jb51.net/article/170008.htm)


